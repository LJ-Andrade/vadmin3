<p-toolbar styleClass="mb-1">
    <div class="p-toolbar-group-start">
        <a [routerLink]="['/', sectionConfig.parentRoute, sectionConfig.model, 'create']">
            <p-button 
                [label]="(sectionConfig.gender === 'F' ? 'Nueva ' : 'Nuevo ') + sectionConfig.nameSingular" 
                icon="pi pi-plus" 
                class="mr-2 main-button"
            />
        </a>

        @if(selectedRows().length > 0) {
            <p-button severity="danger" label="Eliminar Seleccionados" icon="pi pi-trash" class="main-button"
                (onClick)="addSelectedToDeleteQueue()"
            />
        }
        <ng-content select="[slot=actions]"></ng-content>
    </div>
    <ng-template #end>
        @if(searchOptionsVisibility) {
            <form (ngSubmit)="onKeywordSearch(keywordInput.value)">
                <p-inputgroup>
                    <input #keywordInput pInputText placeholder="Palabra clave" />
                    <p-button label="Buscar" type="submit" class="main-button" />
                    @if(keywordInput.value && keywordInput.value.length > 0) {
                        <p-button icon="pi pi-trash" class="ml-2" severity="danger" [rounded]="true" [text]="true" (onClick)="keywordInput.value=''; onKeywordSearch('')" />
                    }
                </p-inputgroup>
            </form>

            @if(advancedSearchAvailable && !advancedSearchOptionsVisibility) {
                <p-button label="BÃºsqueda Avanzada" 
                class="ml-2 main-button" [styleClass]="'text-nowrap'"
                (onClick)="toggleAdvancedSearchOptions()" />
            }

            <p-button icon="pi pi-times" [rounded]="true" [text]="true" severity="danger" class="ml-2"
                (onClick)="toggleSearchOptions(false)" />
        }  @else {
            <p-button icon="pi pi-search" [rounded]="true" [text]="true" [raised]="true"
            (onClick)="toggleSearchOptions()" />
        }
    </ng-template>
</p-toolbar>

<!-- ADVANCE SEARCH -->
<p-toolbar styleClass="mb-2 " *ngIf="advancedSearchOptionsVisibility && advancedSearchAvailable">
	<ng-template #start>
		<!-- SEARCH FORM -->
		<form [formGroup]="searchForm" (ngSubmit)="submitSearch()">
			<div class="flex flex-wrap gap-3 justify-content-center md:flex-row sm:flex-column w-full">
				@for(item of listData; track $index) {
					@if(item.search) {
						@if(item.search.type == 'select') {
							<div class="flex flex-column gap-2 w-full sm:w-full md:w-auto align-items-center">

								@if(item.search.options.items != undefined && item.search.options.items.length > 0) {
									<p-select class="w-full"
										pSize="small"
										[formControlName]="item.value"
										[options]="item.search.options.items"
										[optionLabel]="item.search.options.labelFieldName"
										[optionValue]="item.search.options.valueFieldName"
										[placeholder]="item.search.placeholder"
									/>
								} @else {
									<p-select class="w-full"
										pSize="small"
										[formControlName]="item.value"
										[options]="relations()[item.search.options.name]"
										[optionLabel]="item.search.options.labelFieldName"
										[optionValue]="item.search.options.valueFieldName"
										[placeholder]="item.search.placeholder"
									/>
								}

							</div>
						} @else {
							<div class="flex flex-column gap-2 w-full sm:w-full md:w-auto align-items-center">
								<input [fluid]="true" pInputText text="text" class="inpueeet"
									pSize="small"
									[formControlName]="item.value"
									[placeholder]="item.search.placeholder"
								/>
							</div>
						}
					}
				}

				<p-button label="Buscar" type="submit" class="main-button"></p-button>
			</div>
		</form>
		
	</ng-template>

	<ng-template #end>
		<p-button label="Limpiar" class="ml-2  main-button" [styleClass]="'text-nowrap'"
			(onClick)="resetAdvancedSearchOptions()" severity="danger" size="small"/>
		<p-button icon="pi pi-times" [rounded]="true" [text]="true" severity="danger" class="ml-2"
			(onClick)="toggleAdvancedSearchOptions()" />
	</ng-template>
</p-toolbar>

<!-- LIST -->
<div>
	<div class="table-responsive mt-3">
		@if(!loading()){
			<table class="table" *ngIf="relationsReady()">
				<!-- List Titles -->
				<thead>
					<tr>
						<th scope="col" class="checkbox-col">
							<p-checkbox #mainCheckbox [binary]="true" (change)="toggleAllRows($event)"></p-checkbox>
						</th>
						@for(column of listData; track $index) {
							@if(!column.hidden && !column.hideOnList) {
								<th scope="col" class="column-title" (click)="sortByColumn(column.name)">
									{{ column.label }}
								</th>
							}
						}
						<th scope="col"></th>
					</tr>
				</thead>
				<!-- List Results -->
				<tbody>
					@for(record of results(); track record.id; let odd = $odd) {
						<tr class="table-row" [class.odd]="odd" [ngClass]="{ 'row-selected': record.selected } ">
							<td class="checkbox-col">
								<p-checkbox [(ngModel)]="record.selected" (onChange)="toggleRowSelection(record)" [binary]="true"></p-checkbox>
							</td>
							@for(item of listData; track $index; let odd = $odd) {
								@if(!item.hidden && !item.hideOnList) {
									@if(item.isRelation) {
										<!-- Relation Data -->
										<td [ngClass]="item['columnClass']">
											
											@if(item.isArray) 
											{
												@for(relation of record[item.relationName]; track $index) 
												{	
													<span [ngClass]="{'inline-flex items-center rounded-md bg-blue-50 px-2 py-1 text-xs font-medium text-blue-700 ring-1 ring-blue-700/10 ring-inset': item.showAsBadge }">
														{{ relation[item.relationDisplayName] }}
													</span>
												}
											} 
											@else
											{
												<span [ngClass]="{'inline-flex items-center rounded-md bg-blue-50 px-2 py-1 text-xs font-medium text-blue-700 ring-1 ring-blue-700/10 ring-inset': item.showAsBadge && record[item.value] != '' }">
													
													<!-- {{ record | json }} -->
													<!-- {{ record[item.name] }} -->
													<!--  {{ item.relationValue }}
													{{ item.relationDisplayName }} -->
													{{ item.relationName | relationLabel:record[item.value]:item.relationDisplayName:item.relationValue }}
												</span>
											}
										</td>

									} @else {
										<!-- Main Data -->
										<td [ngClass]="item['columnClass']">
											<span
													[ngClass]="item.showAsBadge && record[item.value] != '' ? 
													'inline-flex items-center rounded-md ' + 
													(item.badgeBgClass || 'bg-blue-50') + 
													' px-2 py-1 text-xs font-medium text-blue-700 ring-1 ring-blue-700/10 ring-inset' 
													: ''"
												>
												@if(item.mutate) {
													{{ item.mutate(record[item.value]) }}
												} @else {
													{{ record[item.value] }}
												}
											</span>
										</td>
									} 
								}
							}
							
							<!-- ROW ACTIONS -->
							<td class="action-column">
								<!-- EDIT ACTION -->
								@if(listConfig.unEditableIds && !listConfig.unEditableIds.includes(+record.id)) {
									<p-button styleClass="mr-3 small-action-button" icon="pi pi-pencil" 
										[rounded]="true" [text]="true" [raised]="true" size="small" 
										class="main-button"
										[routerLink]="['/', sectionConfig.parentRoute, sectionConfig.model, 'edit', record.id]	"
									/>
								}

								<!-- DELETE ACTION -->
								@if(listConfig.unEditableIds && !listConfig.unDeleteableIds.includes(+record.id)) {
									<p-button styleClass="small-action-button" icon="pi pi-trash" [rounded]="true" [text]="true"
										[raised]="true" severity="danger" size="small"
										(onClick)="deleteSingleRecord(record)" />
								} 
							</td>
						</tr>
					}

					

				</tbody>
			</table>
		} @else {
			<app-skeleton [rowsAmount]="5"></app-skeleton>
		}
	</div>
	<p-paginator
		*ngIf="pagination()"
		[first]="0"
		[rows]="pagination()?.list_regs_per_page"
		[rowsPerPageOptions]="[5, 10, 20]"
		[totalRecords]="pagination()?.total"
		[showCurrentPageReport]="true"
		(onPageChange)="onPageChange($event.page, $event.rows)"
		[alwaysShow]="true"
	></p-paginator>
</div>  <!-- End List container -->

<p-dialog header="Do you want to delete this record?" [(visible)]="displayDeleteConfirmation" [style]="{ width: '350px' }" [modal]="true">
	<div class="flex items-center justify-center">
		<i class="pi pi-exclamation-triangle mr-4" style="font-size: 2rem"> </i>
		<span>Click YES to proceed.</span>
	</div>
	<ng-template #footer>
		<p-button label="No" icon="pi pi-times" (click)="closeDeleteConfirmation()" text severity="secondary" />
		<p-button label="YES" icon="pi pi-check" (click)="confirmDelete()" severity="danger" outlined autofocus />
	</ng-template>
</p-dialog>